<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>RegistroMenu.html</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --negro:#000; --dorado:#d4af37; --gris:#f3f3f3; }
    *{box-sizing:border-box}
    body{
      display:flex;justify-content:center;align-items:center;min-height:100vh;
      background:#f9f9f9;font-family:'Helvetica Neue',Arial,sans-serif;margin:0
    }
    .card{
      background:#fff;border-radius:20px;padding:32px 24px;width:92%;max-width:440px;
      text-align:center;box-shadow:0 8px 30px rgba(0,0,0,.05)
    }
    .card h2{font-weight:600;font-size:20px;margin:0 0 6px}
    .qr-tag{
      margin:2px 0 16px;font-family:ui-monospace,Menlo,Consolas,monospace;
      background:#111;color:#fff;display:inline-block;padding:6px 10px;border-radius:8px
    }
    .row{display:grid;gap:10px;margin-top:10px}
    select,button{
      width:100%;padding:12px;font-size:14px;border-radius:10px;border:1px solid #ddd;background:#fff
    }
    button{
      border:none;background:var(--negro);color:var(--dorado);font-weight:700;cursor:pointer;
      transition:transform .2s ease,opacity .2s ease;margin-top:12px
    }
    button[disabled]{opacity:.6;cursor:not-allowed}
    button:hover:not([disabled]){transform:translateY(-2px)}
    #mensaje{margin-top:14px;font-weight:600;font-size:14px}
    .ok{color:#1a7f37}
    .err{color:#b42318}
    .muted{color:#666;font-weight:500}
    .codes{
      background:var(--gris);border-radius:12px;padding:12px;margin-top:10px;font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:14px;text-align:left
    }
    .inline{display:flex;gap:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Asignar c√≥digo de tienda</h2>
    <div class="qr-tag" id="qrBadge">QR: ‚Äî</div>

    <form id="form" class="row">
      <select id="tipoSelect" required>
        <option value="">-- Selecciona Tipo --</option>
      </select>

      <select id="nombreSelect" required disabled>
        <option value="">-- Selecciona Nombre --</option>
      </select>

      <select id="colaboradorSelect" required>
        <option value="">-- Selecciona Colaborador --</option>
        <option>Perla</option>
        <option>Sof√≠a</option>
        <option>Edgar</option>
        <option>Rodolfo</option>
        <option>Alfredo</option>
        <option>Rocio</option>
        <option>Pablo</option>
        <option>Kenia</option>
      </select>

      <button id="btnGuardar" type="submit">Asignar a este QR</button>
    </form>

    <p id="mensaje" class="muted">El QR llega en la URL como <b>?qr=A2IGV0</b></p>

    <div id="salida" style="display:none">
      <div class="codes" id="codesBox"></div>
      <div class="inline">
        <button id="btnCopiar" type="button">Copiar</button>
        <button id="btnNuevo" type="button" onclick="location.reload()">Otro</button>
      </div>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://vyagabfmbyjcbslfdgua.supabase.co";
    const supabaseKey = "sb_publishable_9fDuHl5nKR_yf1RnQ95JBA_Sb_jGK8B";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const productos = [
      { tipo: "Gorra", nombre: "Gorra Trebol Negra/Red Goma Verde" },
      // ... lista completa ...
    ];

    const qrBadge      = document.getElementById("qrBadge");
    const form         = document.getElementById("form");
    const tipoSelect   = document.getElementById("tipoSelect");
    const nombreSelect = document.getElementById("nombreSelect");
    const colaboradorSelect = document.getElementById("colaboradorSelect");
    const btnGuardar   = document.getElementById("btnGuardar");
    const mensaje      = document.getElementById("mensaje");
    const salida       = document.getElementById("salida");
    const codesBox     = document.getElementById("codesBox");
    const btnCopiar    = document.getElementById("btnCopiar");

    function getQRfromURL(){
      const url = new URL(window.location.href);
      const raw = url.searchParams.get("qr") || "";
      return raw.toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,6);
    }

    function randFrom(chars, len){
      let out=""; for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    function generarCodigoTienda(){
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      return "FH" + randFrom(chars, 6);
    }

    async function existeCodigoTienda(codigo){
      const { count, error } = await supabase
        .from("certificaciones")
        .select("codigo_tienda", { count: "exact", head: true })
        .eq("codigo_tienda", codigo);
      if (error) throw error;
      return (count ?? 0) > 0;
    }

    async function generarCodigoTiendaUnico(max=50){
      for(let i=0;i<max;i++){
        const c = generarCodigoTienda();
        if(!(await existeCodigoTienda(c))) return c;
      }
      throw new Error("No fue posible generar un c√≥digo de tienda √∫nico.");
    }

    async function obtenerQR(qr){
      const { data, error } = await supabase
        .from("certificaciones")
        .select("fortune_qr,codigo_tienda,producto")
        .eq("fortune_qr", qr)
        .maybeSingle();
      if (error) throw error;
      return data;
    }

    // Poblar selects de tipo/nombre
    (function poblarTipos(){
      const tipos = [...new Set(productos.map(p => p.tipo))].sort();
      for(const t of tipos){
        const op = document.createElement("option");
        op.value = t; op.textContent = t;
        tipoSelect.appendChild(op);
      }
    })();

    tipoSelect.addEventListener("change", () => {
      nombreSelect.innerHTML = '<option value="">-- Selecciona Nombre --</option>';
      nombreSelect.disabled = !tipoSelect.value;
      if(!tipoSelect.value) return;
      const nombres = [...new Set(productos.filter(p => p.tipo===tipoSelect.value).map(p => p.nombre))].sort();
      for(const n of nombres){
        const op = document.createElement("option");
        op.value = n; op.textContent = n;
        nombreSelect.appendChild(op);
      }
    });

    let QR = "";

    (async function init(){
      QR = getQRfromURL();
      qrBadge.textContent = QR ? `QR: ${QR}` : "QR: ‚Äî";

      if(!QR || QR.length!==6){
        mensaje.className = "err";
        mensaje.textContent = "‚ùå Falta el par√°metro ?qr= o es inv√°lido.";
        btnGuardar.disabled = true;
        return;
      }

      mensaje.className = "muted";
      mensaje.textContent = "Verificando QR‚Ä¶";

      try{
        const reg = await obtenerQR(QR);
        if(!reg){
          mensaje.className = "err";
          mensaje.textContent = "‚ùå El QR no existe.";
          btnGuardar.disabled = true;
          return;
        }
        if(reg.codigo_tienda){
          mensaje.className = "err";
          mensaje.innerHTML = `‚ö†Ô∏è Este QR ya tiene un c√≥digo: <b>${reg.codigo_tienda}</b>.`;
          btnGuardar.disabled = true;
          return;
        }
        mensaje.className = "ok";
        mensaje.textContent = "‚úÖ QR v√°lido. Completa los campos.";
      }catch(err){
        mensaje.className = "err";
        mensaje.textContent = "‚ùå Error verificando QR: " + (err.message || err);
        btnGuardar.disabled = true;
      }
    })();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      salida.style.display = "none";
      mensaje.className = "muted";
      mensaje.textContent = "Asignando‚Ä¶";
      btnGuardar.disabled = true;

      try{
        const tipo = tipoSelect.value;
        const nombre = nombreSelect.value;
        const colaborador = colaboradorSelect.value;

        if(!tipo || !nombre || !colaborador){
          mensaje.className = "err";
          mensaje.textContent = "‚ùå Todos los campos son obligatorios.";
          btnGuardar.disabled = false;
          return;
        }

        const prodObj = productos.find(p => p.tipo === tipo && p.nombre === nombre);
        if(!prodObj){
          mensaje.className = "err";
          mensaje.textContent = "‚ùå Producto no encontrado en cat√°logo.";
          btnGuardar.disabled = false;
          return;
        }
        const productoFinal = prodObj.nombre;

        const reg = await obtenerQR(QR);
        if(!reg){
          mensaje.className = "err";
          mensaje.textContent = "‚ùå El QR ya no existe.";
          return;
        }
        if(reg.codigo_tienda){
          mensaje.className = "err";
          mensaje.textContent = `‚ö†Ô∏è El QR ya fue tomado: ${reg.codigo_tienda}`;
          return;
        }

        const codigo_tienda = await generarCodigoTiendaUnico();

        const payload = {
          codigo_tienda,
          producto: productoFinal,
          colaborador,
          fecha_venta: new Date().toISOString()
        };

        const { error: updErr } = await supabase
          .from("certificaciones")
          .update(payload)
          .eq("fortune_qr", QR);

        if (updErr) throw updErr;

        codesBox.innerHTML = `
          <div><b>QR:</b> ${QR}</div>
          <div><b>C√≥digo Tienda:</b> ${codigo_tienda}</div>
          <div><b>Producto:</b> ${productoFinal}</div>
          <div><b>Colaborador:</b> ${colaborador}</div>
        `;
        salida.style.display = "block";
        mensaje.className = "ok";
        mensaje.textContent = "‚úÖ Asignaci√≥n guardada.";
      } catch(err){
        mensaje.className = "err";
        mensaje.textContent = "‚ùå Error: " + (err.message || err);
      } finally {
        btnGuardar.disabled = false;
      }
    });

    btnCopiar.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(codesBox.innerText.trim());
        mensaje.className = "ok";
        mensaje.textContent = "üìã Copiado al portapapeles.";
      }catch{
        mensaje.className = "err";
        mensaje.textContent = "‚ùå No se pudo copiar.";
      }
    });
  </script>
</body>
</html>
